name: Build Multi-Arch

on:
  workflow_call:
    inputs:
      sha:
        description: 'SHA to use as image tag'
        required: true
        type: string
      branch_slug:
        description: 'String to tag on image'
        required: true
        type: string
      repo_name:
        description: 'Name of repo'
        required: true
        type: string
      dependency_clone:
        description: "dependency repo to clone"
        required: false
        default: false
        type: 'boolean'
      dependency_repo:
        description: "dependency repo to clone"
        required: false
        type: string
      dependency_ref:
        description: "dependency repo to clone"
        required: false
        type: string
      docker_targets:
        description: "Build targets (JSON array)"
        required: false
        default: '["final"]'
        type: string

env:
  REPO: ${{ inputs.repo_name }}
  ORG: ${{ github.repository_owner }}
  SHA: ${{ inputs.sha }}
  REGISTRY_IMAGE: ghcr.io/${{ github.repository_owner }}/${{ inputs.repo_name }}

jobs:
  determine_build_target:
    name: Determine Target
    runs-on: ubuntu-latest # Can be a fast, standard runner
    outputs:
      # Output is now based on which step successfully ran
      target_environment: ${{ steps.check_prod.outputs.environment || steps.check_public.outputs.environment || steps.check_fallback.outputs.environment }}
      
    steps:
      - uses: step-security/harden-runner@v2.14.0
        with:
          egress-policy: audit

      - name: Start timer
        id: start-time
        run: echo "start_time=$(date +%s)" >> $GITHUB_ENV

      - name: CHECK Production Tag (v*.*.*)
        id: check_prod
        if: |
          startsWith(github.ref, 'refs/tags/') &&
          startsWith(github.ref_name, 'v') &&
          !contains(github.ref_name, '-pub') &&
          !contains(github.ref_name, '-beta') &&
          !contains(github.ref_name, '-test') &&
          !contains(github.ref_name, '-dev') &&
          !contains(github.ref_name, '-rc')
        run: echo "environment=production" >> $GITHUB_OUTPUT

      - name: CHECK Public Tag (v*.*.*-pub or -beta)
        id: check_public
        if: |
          steps.check_prod.outcome != 'success' &&
          startsWith(github.ref, 'refs/tags/') &&
          (contains(github.ref_name, '-pub') || contains(github.ref_name, '-beta'))
        run: echo "environment=public" >> $GITHUB_OUTPUT

      - name: CHECK Fallback (branch or rejected tags)
        id: check_fallback
        if: |
          steps.check_prod.outcome != 'success' &&
          steps.check_public.outcome != 'success'
        run: echo "environment=staging" >> $GITHUB_OUTPUT

      - name: Handle build failure
        if: ${{ failure() }}
        run: echo "Build failed. Check logs for details."

      - name: End timer and calculate duration
        id: set-duration
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ env.start_time }}))
          echo "duration=${duration}" >> $GITHUB_OUTPUT

  build_arch:
    name: Build Image (${{ matrix.target }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    environment:
      name: ${{ needs.determine_build_target.outputs.target_environment }}
    needs: [determine_build_target]
    strategy:
      matrix:
        arch: [amd64, arm64]
        target: ${{ fromJSON(inputs.docker_targets) }}
        include:
          - arch: amd64
            runner: large-amd64 #[self-hosted, linux, x64]
            platform: linux/amd64
          - arch: arm64
            runner: large-arm64 #[self-hosted, linux, arm64]
            platform: linux/arm64
    env:
      ACTIONS_RESULTS_URL: ${{ matrix.arch == 'arm64' && secrets.CACHE_SERVER_URL_ARM64 || secrets.CACHE_SERVER_URL }}

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - uses: step-security/harden-runner@v2.14.0
        with:
          egress-policy: audit

      - name: Start timer
        id: start-time
        run: echo "start_time=$(date +%s)" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          persist-credentials: false

      - name: Prepare
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5.8.0
        with:
          images: ${{ env.REGISTRY_IMAGE }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.5.0
        with:
          registry: ghcr.io
          username: ${{ secrets.GH_ACTION_ACTOR }}
          password: ${{ secrets.GH_ACTION_PAT }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Cache Docker layers
        uses: actions/cache@v4.2.4
        with:
          path: ${{ runner.temp }}/.buildx-cache-${{ matrix.arch }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}-${{ matrix.arch }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.arch }}-

      - name: Echo variable
        run: |
          echo "------------------"
          echo ${{ vars.FEATURES }}
          echo $FEATURES
          echo "------------------"

      - name: Build and push ${{ matrix.arch }} image
        id: build
        uses: docker/build-push-action@v6.18.0
        env:
          BRANCH: ${{ env.CLEAN_BRANCH }}
        with:
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.metadata.outputs.tags }},${{ env.REGISTRY_IMAGE }}
          target: ${{ matrix.target }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,push-by-digest=true,name=${{ env.REGISTRY_IMAGE }},push=true
          secrets: |
            github_token=${{ secrets.GH_ACTION_PAT }}
            github_username=${{ secrets.GH_ACTION_USER }}
          build-args: |
            RSP_TAG=${{ secrets.RSP_TAG }}
            RSP_FILENAME=rsp-${{ matrix.arch }}
            SOLANA_STUB_PROVER_FILENAME=solana-stub-prover-${{ matrix.arch }}
            TXNPROVER_TAG=${{ secrets.TXNPROVER_TAG }}
            GITHUB_ORGANIZATION=${{ env.ORG }}
            FEATURES=${{ vars.FEATURES }}
            ARCH=${{ matrix.arch }}

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "${{ runner.temp }}/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4.3.6
        with:
          name: digests-${{ env.PLATFORM_PAIR }}-${{ matrix.target }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: warn
          retention-days: 30
          compression-level: 0
          overwrite: true

      - name: Handle build failure
        if: ${{ failure() }}
        run: echo "Build failed. Check logs for details."

      - name: End timer and calculate duration
        id: set-duration
        run: |
          end_time=$(date +%s)
          duration=$((end_time - ${{ env.start_time }}))
          echo "duration=${duration}" >> $GITHUB_OUTPUT

  merge:
    runs-on: ubuntu-latest
    needs:
      - build_arch
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: step-security/harden-runner@v2.14.0
        with:
          egress-policy: audit

      - name: Download digests
        uses: actions/download-artifact@v5.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.5.0
        with:
          registry: ghcr.io
          username: ${{ secrets.GH_ACTION_ACTOR }}
          password: ${{ secrets.GH_ACTION_PAT }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5.8.0
        with:
          images: ${{ env.REGISTRY_IMAGE }}
          tags: |
            type=raw,value=${{ env.SHA }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
        env:
          BRANCH: ${{ env.CLEAN_BRANCH }}

      - name: Create manifest list and push
        working-directory: ${{ runner.temp }}/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY_IMAGE }}@sha256:%s ' *)

      - name: Sign the images
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # Create a space-separated list of tags
          images=""
          for tag in ${TAGS}; do
            images+="${tag} "
          done
          
          # Sign all tags using Keyless OIDC
          cosign sign --yes ${images}

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY_IMAGE }}:${{ steps.meta.outputs.version }}

  verify-sig:
    runs-on: ubuntu-latest
    needs: merge
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Verify Image Signature
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/${{ inputs.repo_name }}:${{ inputs.sha }}
          IDENTITY_REGEX: "^https://github.com/${{ github.repository }}/.*"
          OIDC_ISSUER: "https://token.actions.githubusercontent.com"
        run: |
          echo "ðŸ” Verifying signature for: $IMAGE"
          
          # 1. Run the verification
          cosign verify \
            --certificate-identity-regexp "$IDENTITY_REGEX" \
            --certificate-oidc-issuer "$OIDC_ISSUER" \
            "$IMAGE"

          # 2. (Optional) Display the command for users to copy-paste
          echo ""
          echo "âœ… Verification Successful! Users can verify this image with:"
          echo "---------------------------------------------------"
          echo "cosign verify \\"
          echo "  --certificate-identity-regexp \"${IDENTITY_REGEX}\" \\"
          echo "  --certificate-oidc-issuer \"${OIDC_ISSUER}\" \\"
          echo "  ${IMAGE}"
          echo "---------------------------------------------------"